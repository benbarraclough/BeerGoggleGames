---
import '../styles.css';
import { withBase, base } from '../lib/paths';

interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
  wide?: boolean;
  fullBleed?: boolean;
}

const {
  title = 'Beer Goggle Games',
  description = 'Drinking games, cocktails, party activities & more.',
  canonical,
  ogImage,
  wide = false,
  fullBleed = false
} = Astro.props as Props;

const current = Astro.url.pathname;
function isActive(segment: string) {
  // segment '' (home) becomes '/'
  const norm = segment.endsWith('/') ? segment : segment + '/';
  return current.startsWith(withBase(norm));
}

// Order required:
// home icon, games, drinks, extras, about, contact, search icon
const navLinks: {
  href: string;
  label: string;
  key: string;        // path segment ('' for home)
  icon?: 'home' | 'search';
}[] = [
  { href: withBase(''),        label: 'Home',    key: '',        icon: 'home' },
  { href: withBase('games/'),  label: 'Games',   key: 'games' },
  { href: withBase('drinks/'), label: 'Drinks',  key: 'drinks' },
  { href: withBase('extras/'), label: 'Extras',  key: 'extras' },
  { href: withBase('about'),   label: 'About',   key: 'about' },
  { href: withBase('contact'), label: 'Contact', key: 'contact' },
  { href: withBase('search'),  label: 'Search',  key: 'search', icon: 'search' }
];

const mainClass = [
  'grow mx-auto w-full px-4 py-8',
  fullBleed ? '' : (wide ? 'max-w-7xl' : 'max-w-6xl')
].join(' ');
---
<!DOCTYPE html>
<html lang="en" class="bg-bg text-fg font-body" data-base={base}>
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    {canonical && <link rel="canonical" href={canonical} />}
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    {ogImage && <meta property="og:image" content={withBase(ogImage.replace(/^\/+/, ''))} />}
  </head>
  <body class="min-h-screen flex flex-col selection:bg-neon/40">

    <header class="border-b border-fg/20 relative z-30">
      <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between gap-6">
        <a href={withBase()} class="font-display text-2xl tracking-tight hover:text-neon whitespace-nowrap">
          BeerGoggleGames
        </a>
        <nav class="hidden lg:flex flex-wrap items-center gap-6 text-sm" aria-label="Primary">
          {navLinks.map(l => {
            const active = isActive(l.key);
            const baseClasses = 'hover:text-neon flex items-center gap-2';
            return (
              <a
                href={l.href}
                class:list={[baseClasses, active && 'text-neon font-semibold']}
                aria-current={active ? 'page' : undefined}
                aria-label={l.icon ? l.label : undefined}
                title={l.icon ? l.label : undefined}
              >
                {l.icon === 'home' && (
                  <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" class="stroke-current" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 11.5 12 3l9 8.5M5 10v10h14V10" />
                  </svg>
                )}
                {l.icon === 'search' && (
                  <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" class="stroke-current" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="7" />
                    <path d="m21 21-4.35-4.35" />
                  </svg>
                )}
                {/* Show text for non-icon links; for icon links we visually hide text but keep for a11y fallback if JS/CSS off */}
                {l.icon
                  ? <span class="sr-only">{l.label}</span>
                  : <span>{l.label}</span>}
              </a>
            );
          })}
        </nav>
        <!-- Burger uses hash target -->
        <a
          id="nav-toggle"
          href="#site-menu"
          class="lg:hidden inline-flex items-center gap-2 border border-fg/30 px-3 py-2 text-sm rounded hover:border-neon hover:text-neon"
          aria-controls="site-menu"
          aria-expanded="false"
        >
          <span class="sr-only">Open menu</span>
          <svg width="22" height="18" viewBox="0 0 22 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="stroke-current">
            <path d="M1 1H21M1 9H21M1 17H21" stroke-width="2" stroke-linecap="round" />
          </svg>
          Menu
        </a>
      </div>
    </header>

    <!-- Pure CSS target overlay -->
    <div id="site-menu" class="site-menu-overlay" aria-label="Mobile navigation">
      <div class="site-menu-panel">
        <div class="flex items-center justify-between px-5 py-4 border-b border-fg/25">
          <span class="font-display text-xl">Menu</span>
          <a
            href="#"
            id="nav-close"
            class="inline-flex items-center gap-2 border border-fg/30 px-3 py-2 text-sm rounded hover:border-neon hover:text-neon"
            aria-label="Close menu"
          >✕</a>
        </div>
        <nav class="px-6 py-8 grow flex flex-col gap-5 text-lg overflow-y-auto" aria-label="Mobile Primary">
          {navLinks.map(l => {
            const active = isActive(l.key);
            return (
              <a
                href={l.href}
                class:list={[
                  'hover:text-neon flex items-center gap-3',
                  active && 'text-neon font-semibold'
                ]}
                aria-current={active ? 'page' : undefined}
                data-close
              >
                {l.icon === 'home' && (
                  <svg aria-hidden="true" viewBox="0 0 24 24" width="22" height="22" class="stroke-current" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 11.5 12 3l9 8.5M5 10v10h14V10" />
                  </svg>
                )}
                {l.icon === 'search' && (
                  <svg aria-hidden="true" viewBox="0 0 24 24" width="22" height="22" class="stroke-current" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="7" />
                    <path d="m21 21-4.35-4.35" />
                  </svg>
                )}
                <span>{l.label}</span>
              </a>
            );
          })}
          <div class="mt-8 pt-6 border-t border-fg/20 text-sm text-muted leading-relaxed max-w-prose">
            <p class="mb-3">
              Explore hundreds of drinking games, cocktails, shots, activities & extras.
            </p>
            <p>Visit the <a class="hover:text-neon underline underline-offset-4" href={withBase('blog/')}>Blog</a> for guides & ideas.</p>
          </div>
        </nav>
      </div>
    </div>

    <main id="main" class={mainClass}>
      <slot />
    </main>

    <footer class="border-t border-fg/20">
      <div class="mx-auto max-w-7xl px-4 py-6 text-sm text-muted flex items-center justify-between">
        <span>© {new Date().getFullYear()} Beer Goggle Games</span>
        <a class="hover:text-neon" href={withBase('rss.xml')}>RSS</a>
      </div>
    </footer>

    <!-- OPTIONAL tiny enhancement script (adds aria-expanded sync) -->
    <script is:inline data-nav-test>
      (function(){
        const toggle = document.getElementById('nav-toggle');
        if(!toggle) return;
        function sync(){
          const expanded = location.hash === '#site-menu';
          toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        }
        window.addEventListener('hashchange', sync);
        sync();
      })();
    </script>
  </body>
</html>
