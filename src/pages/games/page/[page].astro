---
import Layout from '../../../components/Layout.astro';
import { getCollection } from 'astro:content';

/**
 * Games pagination page.
 * Refactored so PER_PAGE is defined inside every scope that needs it,
 * eliminating any chance of an undefined reference during getStaticPaths.
 */

export async function getStaticPaths() {
  const PER_PAGE = 40;
  const games = await getCollection('games').catch(() => []);
  const totalPages = Math.max(1, Math.ceil(games.length / PER_PAGE));
  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
    props: { currentPage: i + 1, totalPages, totalItems: games.length, perPage: PER_PAGE }
  }));
}

const base = import.meta.env.BASE_URL || '/';
const { currentPage, totalPages, totalItems, perPage } = Astro.props;

// Use the perPage value passed via props (fallback to 40 if absent)
const PER_PAGE = typeof perPage === 'number' ? perPage : 40;

const all = (await getCollection('games').catch(() => []))
  .sort((a, b) => a.data.title.localeCompare(b.data.title));

const start = (currentPage - 1) * PER_PAGE;
const items = all.slice(start, start + PER_PAGE);

const pageTitle = totalPages > 1 ? `Games – Page ${currentPage}` : 'Games';
---
<Layout title={pageTitle}>
  <section class="prose max-w-none">
    <h1>{pageTitle}</h1>
    <p>Total games: {totalItems}{totalPages > 1 && ` (Page ${currentPage} of ${totalPages})`}</p>

    <ul class="columns-1 sm:columns-2 lg:columns-3 gap-4 !mt-4">
      {items.map(g => (
        <li class="break-inside-avoid">
          <a class="text-blue-600 hover:underline" href={`${base}games/${g.slug}/`}>{g.data.title}</a>
          {g.data.type && <small class="text-gray-500"> ({g.data.type})</small>}
        </li>
      ))}
    </ul>

    {totalPages > 1 && (
      <nav class="mt-6 flex flex-wrap gap-4 text-sm">
        {currentPage > 1 && (
          <a class="text-blue-600 hover:underline" href={`${base}games/page/${currentPage - 1}/`}>← Prev</a>
        )}
        {currentPage < totalPages && (
          <a class="text-blue-600 hover:underline" href={`${base}games/page/${currentPage + 1}/`}>Next →</a>
        )}
        <a class="text-blue-600 hover:underline" href={`${base}games/`}>First Page</a>
      </nav>
    )}
  </section>
</Layout>
