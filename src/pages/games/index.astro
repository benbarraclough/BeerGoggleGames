---
import Layout from '../../components/Layout.astro';
import { getCollection } from 'astro:content';
import { excludeLegacyNoise } from '../../lib/filters';
import { withBase } from '../../lib/paths';
import { canonical } from '../../lib/urls';

const games = excludeLegacyNoise(await getCollection('games'));
const byType = new Map<string, { count: number; examples: string[] }>();
for (const g of games) {
  const rawType = g.data.type || 'misc';
  if (!byType.has(rawType)) byType.set(rawType, { count: 0, examples: [] });
  const bucket = byType.get(rawType)!;
  bucket.count++;
  if (bucket.examples.length < 3) bucket.examples.push(g.data.title);
}
const typeEntries = Array.from(byType.entries()).sort((a,b)=> a[0].localeCompare(b[0]));

function displayTypeLabel(slug: string) {
  if(!slug) return 'Games';
  const cap = slug.charAt(0).toUpperCase() + slug.slice(1);
  if (/games$/i.test(cap)) return cap;
  return `${cap} Games`;
}

const pageCanonical = canonical(Astro.url.pathname, Astro.site);
---
<Layout
  title="Game Types"
  description="Browse drinking games by category."
  canonical={pageCanonical}
>
  <article class="prose prose-invert max-w-none">
    <h1 class="font-display text-3xl mb-6">Game Types</h1>
  </article>
  <p class="text-sm text-muted mb-6">
    Select a category to view a list of games.
  </p>

  {typeEntries.length === 0 ? (
    <p class="text-muted">No games found.</p>
  ) : (
    <ul class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 list-none p-0 m-0">
      {typeEntries.map(([type, info]) => (
        <li class="p-0 m-0 list-none">
          <a
            href={withBase(`games/${type}/`)}
            class="group flex flex-col h-full border border-fg/20 rounded-sm p-4 transition-colors hover:border-neon/40 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-neon/60 focus-visible:border-neon/60"
            aria-label={`View ${displayTypeLabel(type)} (${info.count} game${info.count !== 1 ? 's' : ''})`}
          >
            <span class="font-semibold leading-snug group-hover:text-neon transition-colors">
              {displayTypeLabel(type)}
            </span>
            <span class="text-xs text-muted mt-1 tracking-tight">
              {info.count} game{info.count !== 1 && 's'}
            </span>
            {info.examples.length > 0 && (
              <ul class="mt-3 text-sm space-y-1 text-muted list-disc list-inside">
                {info.examples.map(ex => <li>{ex}</li>)}
              </ul>
            )}
          </a>
        </li>
      ))}
    </ul>
  )}

  <div class="mt-10 text-sm flex flex-wrap gap-6">
    <a class="hover:text-neon underline underline-offset-4" href={withBase('games/all/')}>All Games (Aâ€“Z)</a>
    <a class="hover:text-neon underline underline-offset-4" href={withBase('games/modes/')}>Player Modes</a>
    <a class="hover:text-neon underline underline-offset-4" href={withBase('games/random')}>Random Game</a>
    <a class="hover:text-neon underline underline-offset-4" href={withBase('tags/')}>Tags</a>
  </div>
</Layout>
