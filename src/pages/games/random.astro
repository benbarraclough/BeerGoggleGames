---
import { getCollection } from 'astro:content';
import Layout from '../../components/Layout.astro';
import { withBase } from '../../lib/paths';

const pageTitle = 'Random Game';
const description = 'Redirecting you to a random drinking game.';

const games = await getCollection('games');

// Build relative slug-based paths and prefix with base for final hrefs
const rawPaths = games.map(g => {
  const parts = g.slug.split('/');
  const type = g.data.type || parts[0] || 'misc';
  const shortSlug = parts[parts.length - 1];
  return `games/${type}/${shortSlug}/`;
});

const uniq = Array.from(new Set(rawPaths));
const fullPaths = uniq.map(p => withBase(p));

const fallback = fullPaths.length
  ? fullPaths[Math.floor(Math.random() * fullPaths.length)]
  : null;
---

<Layout title={pageTitle} description={description} noindex={true}>
  <h1 class="font-display text-3xl mb-4">{pageTitle}</h1>

  {fullPaths.length === 0 ? (
    <p class="text-muted">No games available.</p>
  ) : (
    <>
      <p class="text-sm text-muted mb-6">
        Taking you to a random game...
        <span class="ml-2 animate-pulse">üçª</span>
      </p>
      <p class="text-xs text-muted">
        If nothing happens (e.g. JavaScript disabled), use the list below.
      </p>

      <noscript>
        <div class="mt-5">
          {fallback && (
            <p class="mb-4">
              <a class="underline hover:text-neon" href={fallback}>
                Go to a random game
              </a>
            </p>
          )}
          <ul class="columns-2 gap-6 text-xs list-none p-0 m-0">
            {fullPaths.slice(0, 40).map(p => (
              <li class="mb-1">
                <a
                  class="hover:text-neon underline underline-offset-4"
                  href={p}
                >
                  {p.replace(/.*games\//, '').replace(/\/$/, '')}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </noscript>

      <!-- Data blob Astro will serialize correctly -->
      <script type="application/json" id="random-game-data">
        {JSON.stringify(fullPaths)}
      </script>

      <!-- Inline redirect script (NO template braces inside) -->
      <script is:inline>
        (function() {
          var el = document.getElementById('random-game-data');
            if(!el) return;
          try {
            var paths = JSON.parse(el.textContent || '[]');
            if(!paths.length) return;
            // Avoid repeating last pick in this session (optional small enhancement)
            try {
              var last = sessionStorage.getItem('lastRandomGame');
            } catch(_) {}
            var pick = paths[Math.floor(Math.random() * paths.length)];
            if (paths.length > 1 && last === pick) {
              // Try one more time to reduce repeat chance
              pick = paths[Math.floor(Math.random() * paths.length)];
            }
            try { sessionStorage.setItem('lastRandomGame', pick); } catch(_) {}
            window.location.replace(pick);
          } catch(e) {
            // Silently fail; user still sees fallback text
            // console.error('Random redirect failed', e);
          }
        })();
      </script>
    </>
  )}
</Layout>
