---
import { getCollection } from 'astro:content';
import Layout from '../../components/Layout.astro';
import { withBase } from '../../lib/paths';

const pageTitle = 'Random Game';
const description = 'Redirecting you to a random drinking game.';

// Collect flat leaves
const games = await getCollection('games');
const leaves = Array.from(
  new Set(
    games.map(g => {
      const slug = g.slug ?? g.id;
      return slug.split('/').pop();
    })
  )
);

const fullPaths = leaves.map(l => withBase(`games/${l}/`));
const fallback = fullPaths.length
  ? fullPaths[Math.floor(Math.random() * fullPaths.length)]
  : null;
---
<Layout title={pageTitle} description={description} noindex={true}>
  <h1 class="font-display text-3xl mb-4">{pageTitle}</h1>

  {fullPaths.length === 0 ? (
    <p class="text-muted">No games available.</p>
  ) : (
    <>
      <p class="text-sm text-muted mb-6">
        Taking you to a random game...
        <span class="ml-2 animate-pulse">üçª</span>
      </p>
      <p class="text-xs text-muted">
        If nothing happens (e.g. JavaScript disabled), use the list below.
      </p>

      <noscript>
        <div class="mt-5">
          {fallback && (
            <p class="mb-4">
              <a class="underline hover:text-neon" href={fallback}>
                Go to a random game
              </a>
            </p>
          )}
          <ul class="columns-2 gap-6 text-xs list-none p-0 m-0">
            {fullPaths.slice(0, 40).map(p => (
              <li class="mb-1">
                <a class="hover:text-neon underline underline-offset-4" href={p}>
                  {p.replace(/.*games\//, '').replace(/\/$/, '')}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </noscript>

      <script
        is:inline
        set:html={`(function(){try{
          var paths = ${JSON.stringify(fullPaths)};
          if(!paths.length) return;
          var last; try{ last = sessionStorage.getItem('lastRandomGame'); }catch(_){}
          var pick = paths[Math.floor(Math.random()*paths.length)];
          if(paths.length>1 && pick===last){
            pick = paths[Math.floor(Math.random()*paths.length)];
          }
          try{ sessionStorage.setItem('lastRandomGame', pick); }catch(_){}
          window.location.replace(pick);
        }catch(e){ console.error('Random redirect failed', e); }} )();`}
      ></script>
    </>
  )}
</Layout>
