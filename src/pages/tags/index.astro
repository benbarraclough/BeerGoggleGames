---
import Layout from '../../components/Layout.astro';
import { getCollection } from 'astro:content';
import { withBase } from '../../lib/paths';
import { uniqueTagSlugs, tagSlug } from '../../lib/tags';

const games = await getCollection('games');
const cocktails = await getCollection('cocktails').catch(()=>[]);
const shots = await getCollection('shots').catch(()=>[]);
const posts = await getCollection('posts').catch(()=>[]);
const activities = await getCollection('activities').catch(()=>[]);

const allTagObjs = uniqueTagSlugs([
  ...games.map(g => g.data.tags),
  ...cocktails.map(c => c.data.tags),
  ...shots.map(s => s.data.tags),
  ...posts.map(p => p.data.tags),
  ...activities.map(a => a.data.tags),
]);

// Count occurrences
const counts = new Map<string, number>();
function add(arr:any[], type:string) {
  for (const item of arr) {
    const tags = item.data.tags || [];
    for (const t of tags) {
      const slug = tagSlug(t);
      counts.set(slug, (counts.get(slug) || 0) + 1);
    }
  }
}
add(games,'game');
add(cocktails,'cocktail');
add(shots,'shot');
add(posts,'post');
add(activities,'activity');

const sorted = allTagObjs
  .map(t => ({ ...t, count: counts.get(t.slug) || 0 }))
  .sort((a,b) => a.label.localeCompare(b.label));

const title = 'All Tags';
const description = 'Browse tags across games, drinks, posts & activities.';
---
<Layout title={title} description={description} canonical={Astro.site && new URL(withBase('tags/'), Astro.site).href}>
  <h1 class="font-display text-4xl mb-6">Tags</h1>
  <p class="text-sm text-muted mb-8">{sorted.length} tag{sorted.length!==1 && 's'} total.</p>
  {sorted.length === 0 ? (
    <p class="text-muted">No tags yet.</p>
  ) : (
    <ul class="flex flex-wrap gap-3 p-0 list-none">
      {sorted.map(t => (
        <li>
          <a href={withBase(`tags/${t.slug}/`)} class="tag-pill" aria-label={`Tag ${t.label} (${t.count})`}>
            {t.label} <span class="opacity-70">({t.count})</span>
          </a>
        </li>
      ))}
    </ul>
  )}
  <div class="mt-10 text-sm flex flex-wrap gap-6">
    <a class="hover:text-neon underline underline-offset-4" href={withBase('games/all/')}>All Games (A-Z)</a>
    <a class="hover:text-neon underline underline-offset-4" href={withBase('games/')}>Game Types</a>
    <a class="hover:text-neon underline underline-offset-4" href={withBase('games/formats/')}>Player Formats</a>
    <a class="hover:text-neon underline underline-offset-4" href={withBase('games/random')}>Random Game</a>
    <a class="hover:text-neon underline underline-offset-4" href={withBase('search')}>Search</a>
  </div>
</Layout>
