---
import Layout from '../../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import RelatedCocktails from '../../../components/RelatedCocktails.astro';
import StructuredData from '../../../components/StructuredData.astro';

export async function getStaticPaths() {
  const shots = await getCollection('shots').catch(() => []);
  return shots.map(s => ({
    params: { slug: s.slug },
    props: { entry: s }
  }));
}

const rawBase = import.meta.env.BASE_URL || '/';
let base = rawBase;
if (!base.startsWith('/')) base = '/' + base;
if (!base.endsWith('/')) base += '/';

const { entry } = Astro.props;
const { Content } = await entry.render();

const title = entry?.data?.title || 'Shot';
if (!entry) throw new Error('Shot not found');

const ingredientsRaw = entry.data.ingredients || [];
const ingredients = ingredientsRaw.map(i => typeof i === 'string' ? i : (i.name || i.ingredient || JSON.stringify(i)));
const method = entry.data.method || entry.data.instructions || entry.data.directions || '';
const description = entry.data.excerpt || `Shot recipe: ${title}.`;
const canonical = new URL(Astro.url.pathname, Astro.site ?? 'https://benbarraclough.github.io/BeerGoggleGames').toString();
const image = entry.data.image || entry.data.images?.[0] || null;

const recipeLd = {
  '@context': 'https://schema.org',
  '@type': 'Recipe',
  name: title,
  description,
  recipeCategory: 'Shot',
  recipeCuisine: 'International',
  recipeIngredient: ingredients,
  recipeInstructions: method
    ? [{ '@type': 'HowToStep', text: method }]
    : undefined,
  image: image
    ? [image.startsWith('http') ? image : `${base}images/${image.replace(/^\/+/, '')}`]
    : undefined,
  url: canonical,
  inLanguage: 'en'
};
---
<Layout title={title} description={description}>
  <article class="prose max-w-none">
    <h1>{title}</h1>
    {ingredients.length > 0 && (
      <>
        <h2>Ingredients</h2>
        <ul>
          {ingredients.map(i => <li>{i}</li>)}
        </ul>
      </>
    )}
    {method && (
      <>
        <h2>Method</h2>
        <p>{method}</p>
      </>
    )}
    <Content />
  </article>

  <div class="mt-10">
    <RelatedCocktails currentSlug={entry.slug} ingredients={ingredients} />
  </div>

  <p class="mt-8">
    <a class="text-blue-600 hover:underline" href={`${base}drinks/shot-recipes/`}>‚Üê All Shots</a>
  </p>

  <StructuredData data={recipeLd} />
</Layout>
