---
import Layout from '../../../components/Layout.astro';
import { getCollection } from 'astro:content';
import RelatedCocktails from '../../../components/RelatedCocktails.astro';
import StructuredData from '../../../components/StructuredData.astro';
import { withBase } from '../../../lib/paths';
import { canonical, imageUrl } from '../../../lib/urls';
import { recipeLD } from '../../../lib/schema';

export async function getStaticPaths() {
  const cocktails = await getCollection('cocktails');
  return cocktails.map(c => ({ params: { slug: c.slug }, props: { entry: c } }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const title = entry.data.title;
const ingredients = (entry.data.ingredients || []).map((i: any) => String(i));
const methodArray = Array.isArray(entry.data.method)
  ? entry.data.method.map((m: any) => String(m))
  : entry.data.method
    ? [String(entry.data.method)]
    : [];
const description = entry.data.excerpt || `Cocktail recipe: ${title}.`;
const pageCanonical = canonical(Astro.url.pathname, Astro.site);
const img = entry.data.image ? imageUrl(entry.data.image) : undefined;

const ld = recipeLD({
  title,
  description,
  ingredients,
  method: methodArray.join(' '),
  url: pageCanonical,
  image: img
});
---
<Layout title={title} description={description} canonical={pageCanonical}>
  <article class="prose prose-invert max-w-none">
    <h1 class="!mb-4 !leading-tight !text-fg font-display text-3xl md:text-4xl">{title}</h1>
    {ingredients.length > 0 && (
      <>
        <h2>Ingredients</h2>
        <ul>
          {ingredients.map(i => <li>{i}</li>)}
        </ul>
      </>
    )}
    {methodArray.length > 0 && (
      <>
        <h2>Method</h2>
        <ol>
          {methodArray.map(step => <li>{step}</li>)}
        </ol>
      </>
    )}
    <Content />
  </article>

  <div class="mt-10">
    <RelatedCocktails currentSlug={entry.slug} ingredients={ingredients} />
  </div>

  <p class="mt-10">
    <a class="hover:text-neon underline underline-offset-4" href={withBase('drinks/cocktail-recipes/')}>‚Üê All Cocktails</a>
  </p>

  <StructuredData data={ld} />
</Layout>
